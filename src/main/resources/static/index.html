<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/style.css">

</head>
<body>
<div class="container">
    <h2>Currency Converter</h2>

    <div class="converter-box">

        <div class="currency-row">
            <input type="number" id="amountLeft" step="0.01">
            <select id="currencyLeft"></select>
        </div>

        <div class="divider">⇄</div>

        <div class="currency-row">
            <input type="number" id="amountRight" step="0.01">
            <select id="currencyRight"></select>
        </div>

    </div>
</div>
<script>
    const currencyLeft = document.getElementById('currencyLeft');
    const currencyRight = document.getElementById('currencyRight');

    // Загружаем список валют при старте страницы
    document.addEventListener('DOMContentLoaded', loadCurrencies);

    async function loadCurrencies() {
        try {
            const response = await fetch('http://localhost:8080/api/exchange/rates');
            const currencies = await response.json();

            fillSelect(currencyLeft, currencies, 'USD');
            fillSelect(currencyRight, currencies, 'EUR');

        } catch (e) {
            console.error('Не удалось загрузить валюты', e);
        }
    }

    // Универсальная функция наполнения select
    function fillSelect(select, currencies, defaultValue) {
        select.innerHTML = '';

        currencies.forEach(code => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = code;
            select.appendChild(option);
        });

        if (defaultValue && currencies.includes(defaultValue)) {
            select.value = defaultValue;
        }
    }

    currencyLeft.addEventListener('change', () => {
        if (currencyLeft.value === currencyRight.value) {
            currencyRight.selectedIndex = 1;
        }
    });

</script>


<script>
    const amountLeft = document.getElementById('amountLeft');
    const amountRight = document.getElementById('amountRight');
    const currencyLeft = document.getElementById('currencyLeft');
    const currencyRight = document.getElementById('currencyRight');

    let activeInput = 'left';

    // Слушаем ввод
    amountLeft.addEventListener('input', () => {
        activeInput = 'left';
        convert();
    });

    amountRight.addEventListener('input', () => {
        activeInput = 'right';
        convert();
    });

    // Слушаем смену валют
    currencyLeft.addEventListener('change', convert);
    currencyRight.addEventListener('change', convert);

    async function convert() {
        let fromCurrency, toCurrency, amount;

        if (activeInput === 'left') {
            amount = parseFloat(amountLeft.value);
            fromCurrency = currencyLeft.value;
            toCurrency = currencyRight.value;
        } else {
            amount = parseFloat(amountRight.value);
            fromCurrency = currencyRight.value;
            toCurrency = currencyLeft.value;
        }

        if (isNaN(amount) || amount <= 0) return;

        try {
            const response = await fetch('http://localhost:8080/api/currency/convert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fromCurrency, toCurrency, amount })
            });

            const data = await response.json();

            if (!response.ok) {
                console.error(data);
                return;
            }

            if (activeInput === 'left') {
                amountRight.value = data.convertedAmount.toFixed(2);
            } else {
                amountLeft.value = data.convertedAmount.toFixed(2);
            }

        } catch (e) {
            console.error('API error', e);
        }
    }
</script>

</body>
</html>