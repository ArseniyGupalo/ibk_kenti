<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="css/style.css">

</head>
<body>
<div class="container">
    <div class="rate-badge" id="rateInfo"></div>

    <h2>Currency Converter</h2>

    <div class="converter-box">

        <div class="currency-row">
            <input type="text" inputmode="decimal" id="amountLeft">
            <select id="currencyLeft"></select>
        </div>

        <div class="divider">⇄</div>

        <div class="currency-row">
            <input type="text" inputmode="decimal" id="amountRight">
            <select id="currencyRight"></select>
        </div>

    </div>
</div>
<script>
    const amountLeft = document.getElementById('amountLeft');
    const amountRight = document.getElementById('amountRight');
    const currencyLeft = document.getElementById('currencyLeft');
    const currencyRight = document.getElementById('currencyRight');

    let activeInput = 'left';
    let rates = {};

    // ---------------- LOAD CURRENCIES ----------------
    document.addEventListener('DOMContentLoaded', loadCurrencies);

    async function loadCurrencies() {
        try {
            const response = await fetch('http://localhost:8080/api/exchange/rates');
            const data = await response.json();

            if (!data.rates) {
                throw new Error('rates is missing in response');
            }

            rates = data.rates;

            const currencies = Object.keys(rates).sort();

            fillSelect(currencyLeft, currencies, 'USD');
            fillSelect(currencyRight, currencies, 'EUR');

            // ⚠️ ОБЯЗАТЕЛЬНО — первый расчёт
            convert();
            updateRateInfo();

        } catch (e) {
            console.error('Ошибка загрузки валют:', e);
        }
    }

    // ---------------- FILL SELECT ----------------
    function fillSelect(select, currencies, defaultValue) {
        select.innerHTML = '';

        currencies.forEach(code => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = code;
            select.appendChild(option);
        });

        select.value = defaultValue;
    }

    // ---------------- EVENTS ----------------
    amountLeft.addEventListener('input', () => {
        sanitizeInput(amountLeft)
        activeInput = 'left';
        convert();
    });

    amountRight.addEventListener('input', () => {
        sanitizeInput(amountRight)
        activeInput = 'right';
        convert();
    });

    currencyLeft.addEventListener('change', () => {
        convert();
        updateRateInfo();
    });

    currencyRight.addEventListener('change', () => {
        convert();
        updateRateInfo();
    });


    // ---------------- CONVERT ----------------
    function convert() {
        if (Object.keys(rates).length === 0) return;

        let amount, fromCurrency, toCurrency;

        if (activeInput === 'left') {
            amount = parseFloat(amountLeft.value);
            fromCurrency = currencyLeft.value;
            toCurrency = currencyRight.value;
        } else {
            amount = parseFloat(amountRight.value);
            fromCurrency = currencyRight.value;
            toCurrency = currencyLeft.value;
        }

        if (isNaN(amount)) return;
        if (!rates[fromCurrency] || !rates[toCurrency]) return;

        const result = amount * (rates[toCurrency] / rates[fromCurrency]);

        if (activeInput === 'left') {
            amountRight.value = result.toFixed(2);
        } else {
            amountLeft.value = result.toFixed(2);
        }
    }

    // ---------------FILTER------------------
    function sanitizeInput(input) {
        input.value = input.value
            .replace(',', '.')          // запятая → точка
            .replace(/[^0-9.]/g, '')    // только цифры и точка
            .replace(/(\..*)\./g, '$1'); // только одна точка
    }

    // ---------------RATE_UPDATE---------------
    const rateInfo = document.getElementById('rateInfo');

    function updateRateInfo() {
        if (!rates || Object.keys(rates).length === 0) return;

        const from = currencyLeft.value;
        const to = currencyRight.value;

        if (!rates[from] || !rates[to]) return;

        const rate = rates[to] / rates[from];

        rateInfo.textContent = `1 ${from} = ${rate.toFixed(4)} ${to}`;
    }


</script>


</body>
</html>